--- a/bigtop-packages/src/common/hadoop/install_hadoop.sh	2016-05-20 10:42:15.000000000 -0500
+++ b/bigtop-packages/src/common/hadoop/install_hadoop.sh	2017-09-06 11:29:52.000000000 -0500
@@ -170,11 +170,16 @@ for component in $HADOOP_DIR/bin/hadoop
 #!/bin/bash

 # Autodetect JAVA_HOME if not defined
-. /usr/lib/bigtop-utils/bigtop-detect-javahome
+. \${SNAP}/usr/lib/bigtop-utils/bigtop-detect-javahome

-export HADOOP_LIBEXEC_DIR=/${SYSTEM_LIBEXEC_DIR#${PREFIX}}
+export HADOOP_LIBEXEC_DIR=\${SNAP}${SYSTEM_LIBEXEC_DIR#${PREFIX}}
+export HADOOP_CONF_DIR=\${SNAP}/etc/hadoop/conf
+export HADOOP_COMMON_HOME=\${SNAP}${HADOOP_DIR#${PREFIX}}
+export HADOOP_HDFS_HOME=\${SNAP}${HDFS_DIR#${PREFIX}}
+export HADOOP_MAPRED_HOME=\${SNAP}${MAPREDUCE_DIR#${PREFIX}}
+export HADOOP_YARN_HOME=\${SNAP}${YARN_DIR#${PREFIX}}

-exec ${component#${PREFIX}} "\$@"
+exec \${SNAP}${component#${PREFIX}} "\$@"
 EOF
   chmod 755 $wrapper
 done
@@ -265,26 +270,26 @@ cat > $fuse_wrapper << EOF
 /sbin/modprobe fuse

 # Autodetect JAVA_HOME if not defined
-. /usr/lib/bigtop-utils/bigtop-detect-javahome
+. \${SNAP}/usr/lib/bigtop-utils/bigtop-detect-javahome

-export HADOOP_HOME=\${HADOOP_HOME:-${HADOOP_DIR#${PREFIX}}}
+export HADOOP_HOME=\${HADOOP_HOME:-\${SNAP}${HADOOP_DIR#${PREFIX}}}

-BIGTOP_DEFAULTS_DIR=\${BIGTOP_DEFAULTS_DIR-/etc/default}
+BIGTOP_DEFAULTS_DIR=\${BIGTOP_DEFAULTS_DIR-\${SNAP}/etc/default}
 [ -n "\${BIGTOP_DEFAULTS_DIR}" -a -r \${BIGTOP_DEFAULTS_DIR}/hadoop-fuse ] && . \${BIGTOP_DEFAULTS_DIR}/hadoop-fuse

-export HADOOP_LIBEXEC_DIR=${SYSTEM_LIBEXEC_DIR#${PREFIX}}
+export HADOOP_LIBEXEC_DIR=\${SNAP}${SYSTEM_LIBEXEC_DIR#${PREFIX}}

 if [ "\${LD_LIBRARY_PATH}" = "" ]; then
   export JAVA_NATIVE_LIBS="libjvm.so"
-  . /usr/lib/bigtop-utils/bigtop-detect-javalibs
-  export LD_LIBRARY_PATH=\${JAVA_NATIVE_PATH}:/usr/lib
+  . \${SNAP}/usr/lib/bigtop-utils/bigtop-detect-javalibs
+  export LD_LIBRARY_PATH=\${JAVA_NATIVE_PATH}:\${SNAP}/usr/lib:/usr/lib
 fi

 # Pulls all jars from hadoop client package
 for jar in \${HADOOP_HOME}/client/*.jar; do
   CLASSPATH+="\$jar:"
 done
-CLASSPATH="/etc/hadoop/conf:\${CLASSPATH}"
+CLASSPATH="\${SNAP}/etc/hadoop/conf:\${CLASSPATH}"

 env CLASSPATH="\${CLASSPATH}" \${HADOOP_HOME}/bin/fuse_dfs \$@
 EOF
@@ -354,7 +359,7 @@ sed -i -e '/<\/configuration>/i\
 \
   <property>\
     <name>httpfs.hadoop.config.dir</name>\
-    <value>/etc/hadoop/conf</value>\
+    <value>${SNAP}/etc/hadoop/conf</value>\
   </property>' $HTTPFS_ETC_DIR/conf.empty/httpfs-site.xml

 # Make the pseudo-distributed config
@@ -375,9 +380,9 @@ cp ${BUILD_DIR}/etc/hadoop/log4j.propert

 # FIXME: Provide a convenience link for configuration (HADOOP-7939)
 install -d -m 0755 ${HADOOP_DIR}/etc
-ln -s ${HADOOP_ETC_DIR##${PREFIX}}/conf ${HADOOP_DIR}/etc/hadoop
+ln -s ../../../..${HADOOP_ETC_DIR##${PREFIX}}/conf ${HADOOP_DIR}/etc/hadoop
 install -d -m 0755 ${YARN_DIR}/etc
-ln -s ${HADOOP_ETC_DIR##${PREFIX}}/conf ${YARN_DIR}/etc/hadoop
+ln -s ../../../..${HADOOP_ETC_DIR##${PREFIX}}/conf ${YARN_DIR}/etc/hadoop

 # Create log, var and lib
 install -d -m 0755 $PREFIX/var/{log,run,lib}/hadoop-hdfs
@@ -402,8 +407,8 @@ install -d -m 0755 ${CLIENT_DIR}
 for file in `cat ${BUILD_DIR}/hadoop-client.list` ; do
   for dir in ${HADOOP_DIR}/{lib,} ${HDFS_DIR}/{lib,} ${YARN_DIR}/{lib,} ${MAPREDUCE_DIR}/{lib,} ; do
     [ -e $dir/$file ] && \
-    ln -fs ${dir#$PREFIX}/$file ${CLIENT_DIR}/${file} && \
-    ln -fs ${dir#$PREFIX}/$file ${CLIENT_DIR}/${file/-[[:digit:]]*/.jar} && \
+    ln -fs ../../../..${dir#$PREFIX}/$file ${CLIENT_DIR}/${file} && \
+    ln -fs ../../../..${dir#$PREFIX}/$file ${CLIENT_DIR}/${file/-[[:digit:]]*/.jar} && \
     continue 2
   done
   exit 1
